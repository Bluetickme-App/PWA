<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>BlueTickMe Fingerprint Authentication</title>
    <script src="domready.js"></script>
    <script src="base64url-arraybuffer.js"></script>
    <script type="text/javascript">
    let getFingerPrintAuth;

    function doesBrowserSupportAuth() {
        return 'credentials' in navigator;
    }

    // function init () {
    //     // when a message is received from the page code
    //     window.onmessage = (event) => {
    //         return;
    //         console.log("onmessage", event);
    //         // if (event.origin !== 'https://www.bluetickme.com' && event.origin !== 'https://bluetickme.com') {
    //         //     console.log("INVALID ORIGIN", event.origin);
    //         //     return;
    //         // }

    //         if (event.data) {
    //             console.log("HTML Code Element received a message!", JSON.parse(event.data));
    //             if (typeof getFingerPrintAuth === 'function') {
    //                 getFingerPrintAuth(event.data);
    //             } else {
    //                 const intervalId = setInterval(() => {
    //                     if (typeof getFingerPrintAuth === 'function') {
    //                         clearInterval(intervalId);
    //                         getFingerPrintAuth(event.data);
    //                     }
    //                 }, 100);
    //             }
    //         }
    //     }
    // }

    function saveFPAuthKey(input) {
        return fetch("/api/save-fingerprint-auth-key", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(input),
        });
    }

    DomReady.ready(function() {
        if (!doesBrowserSupportAuth()) {
            alert("Fingerprint not supported by your browser.");
            window.close();
            return;
        }

        const url = new URL(window.location);
        const deviceId = url.searchParams.get('did');
        const userId = url.searchParams.get('uid');
        const userName = url.searchParams.get('un');
        const userDisplayName = url.searchParams.get('udn');
        const challenge = url.searchParams.get('c');

        if (!deviceId || !userId || !userName || !userDisplayName || !challenge) {
            console.log("Invalid url query params");
            window.close();
            return;
        }

        const base64urlEncode = base64url.encode;
        const base64urlDecode = base64url.decode;
        const getAttestation = (user, challenge) =>  {
            return navigator.credentials.create({
                publicKey: {
                    authenticatorSelection: {
                        // cross-platform / platform
                        authenticatorAttachment: "platform",
                        userVerification: "required"
                    },
                    challenge: base64urlDecode(challenge),
                    rp: {
                        id: document.domain,
                        name: "Bluetickme",
                    },
                    user: {
                        id: base64urlDecode(user.id),
                        name: user.name,
                        displayName: user.displayName,
                    },
                    pubKeyCredParams: [
                        { type: "public-key", alg: -7 },
                        { type: "public-key", alg: -257 }
                    ]
                }
            });
        };

        function publicKeyCredentialToJSON(pubKeyCred) {
            if (pubKeyCred instanceof ArrayBuffer) {
                return base64urlEncode(pubKeyCred);
            } else if (pubKeyCred instanceof Array) {
                return pubKeyCred.map(publicKeyCredentialToJSON);
            } else if (pubKeyCred instanceof Object) {
                const obj = {};
                for (let key in pubKeyCred) {
                    obj[key] = publicKeyCredentialToJSON(pubKeyCred[key]);
                }
                return obj;
            } else return pubKeyCred;
        }

        getFingerPrintAuth = async (deviceId, message) => {
            const messageObject = message;
            if (!messageObject.challenge || !messageObject.user) {
                console.log("INVALID DATA");
                return;
            }

            navigator.credentials.preventSilentAccess();
            try {
                const attestation = await getAttestation(messageObject.user, messageObject.challenge);
                const webAuthnAttestation = publicKeyCredentialToJSON(attestation);
                const input = {
                    device_id: deviceId,
                    public_key: webAuthnAttestation.id,
                    type: webAuthnAttestation.type,
                    attestation_object: webAuthnAttestation.response.attestationObject,
                    client_data_json: webAuthnAttestation.response.clientDataJSON,
                };
                const response = await saveFPAuthKey(input);
                const jsonResponse = JSON.parse(await response.text());
                console.log("jsonResponse", jsonResponse);
                window.close();
            } catch (error) {
                alert(error.message);
                window.close();
            }
        };

        getFingerPrintAuth(deviceId, {
            challenge: challenge,
            user: {
                id: userId,
                name: userName,
                displayName: userDisplayName,
            },
        });
    });
    </script>
</head>

<body>
</body>
</html>
