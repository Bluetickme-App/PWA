<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>BlueTickMe Fingerprint Authentication</title>
    <script src="domready.js"></script>
    <script src="base64url-arraybuffer.js"></script>
    <script type="text/javascript">
    let fingerPrintAuth;

    function doesBrowserSupportAuth() {
        return 'credentials' in navigator;
    }

    // function init () {
    //     console.log("INIT called")
    //     // when a message is received from the page code
    //     window.onmessage = (event) => {
    //         console.log("onmessage", event);
    //         // if (event.origin !== 'https://www.bluetickme.com' && event.origin !== 'https://bluetickme.com') {
    //         //     console.log("INVALID ORIGIN", event.origin);
    //         //     return;
    //         // }

    //         if (event.data) {
    //             console.log("HTML Code Element received a message!", JSON.parse(event.data));
    //             if (typeof fingerPrintAuth === 'function') {
    //                 fingerPrintAuth(event.data);
    //             } else {
    //                 const intervalId = setInterval(() => {
    //                     if (typeof fingerPrintAuth === 'function') {
    //                         clearInterval(intervalId);
    //                         fingerPrintAuth(event.data);
    //                     }
    //                 }, 100);
    //             }
    //         }
    //     }

    //     // console.log("ABC")
    //     // window.postMessage(JSON.stringify({
    //     //     challenge: 'e21d109e-2eec-41a7-9c2e-ed60a959b7bb',
    //     //     publicKey: 'AXNePBgAuQ0MydvWDPeqFsNZ2byFyzuA-Znkkjpj1n9PthMKKeKbhGllMeAQcoir'
    //     // }));
    // }

    function signIn(input) {
        return fetch("/api/fingerprint-sign-in", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(input),
        });
    }

    DomReady.ready(function() {
        if (!doesBrowserSupportAuth()) {
            alert("Fingerprint not supported by your browser.");
            window.close();
            return;
        }

        const url = new URL(window.location);
        const deviceId = url.searchParams.get('did');
        const publicKey = url.searchParams.get('p');
        const challenge = url.searchParams.get('c');

        if (!deviceId || !publicKey || !challenge) {
            console.log("Invalid url query params");
            window.close();
            return;
        }

        const base64urlEncode = base64url.encode;
        const base64urlDecode = base64url.decode;
        const getAttestation = (publicKey, challenge) =>  {
            return navigator.credentials.get({
                publicKey: {
                    authenticatorSelection: {
                        authenticatorAttachment: "platform",
                        userVerification: "required"
                    },
                    challenge: base64urlDecode(challenge),
                    rpId: document.domain,
                    allowCredentials: [
                        {
                            type: "public-key",
                            id: base64urlDecode(publicKey),
                        }
                    ],
                    userVerification: "required",
                    timeout: 60000,
                }
            });
        };

        function publicKeyCredentialToJSON(pubKeyCred) {
            if (pubKeyCred instanceof ArrayBuffer) {
                return base64urlEncode(pubKeyCred);
            } else if (pubKeyCred instanceof Array) {
                return pubKeyCred.map(publicKeyCredentialToJSON);
            } else if (pubKeyCred instanceof Object) {
                const obj = {};
                for (let key in pubKeyCred) {
                    obj[key] = publicKeyCredentialToJSON(pubKeyCred[key]);
                }
                return obj;
            } else return pubKeyCred;
        }

        fingerPrintAuth = async (deviceId, message) => {
            const messageObject = message;
            try {
                const attestation = await getAttestation(messageObject.publicKey, messageObject.challenge);
                const webAuthnAssertion = publicKeyCredentialToJSON(attestation);

                const input = {
                    device_id: deviceId,
                    public_key: webAuthnAssertion.id,
                    type: webAuthnAssertion.type,
                    authenticator_data: webAuthnAssertion.response.authenticatorData,
                    client_data_json: webAuthnAssertion.response.clientDataJSON,
                    signature: webAuthnAssertion.response.signature,
                    user_handle: webAuthnAssertion.response.userHandle,
                };

                const response = await signIn(input);
                const jsonResponse = JSON.parse(await response.text());
                console.log("jsonResponse", jsonResponse);
                window.close();
            } catch (error) {
                alert(error.message);
                window.close();
            }
        };

        fingerPrintAuth(deviceId, {
            challenge,
            publicKey,
        });
    });
    </script>
</head>

<body>
</body>
</html>
